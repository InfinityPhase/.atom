!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("fs-plus"),require("request"),require("querystringify"),require("tmp"),require("semver"),require("cross-spawn"),require("tar"),require("jsonrpc-lite"),require("tcp-port-used"),require("ws"),require("glob")):"function"==typeof define&&define.amd?define("platformio-node-helpers",["fs-plus","request","querystringify","tmp","semver","cross-spawn","tar","jsonrpc-lite","tcp-port-used","ws","glob"],t):"object"==typeof exports?exports["platformio-node-helpers"]=t(require("fs-plus"),require("request"),require("querystringify"),require("tmp"),require("semver"),require("cross-spawn"),require("tar"),require("jsonrpc-lite"),require("tcp-port-used"),require("ws"),require("glob")):e["platformio-node-helpers"]=t(e["fs-plus"],e.request,e.querystringify,e.tmp,e.semver,e["cross-spawn"],e.tar,e["jsonrpc-lite"],e["tcp-port-used"],e.ws,e.glob)}(global,(function(e,t,r,n,i,o,s,a,u,l,c){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(n,i,function(t){return e[t]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=14)}([function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IS_WINDOWS=void 0,t.sleep=function(e){return new Promise(t=>setTimeout(t,e))},t.patchOSEnviron=function({caller:e,useBuiltinPIOCore:t=!0,extraPath:r,extraVars:i}){process.env.PLATFORMIO_CALLER=e,"darwin"===process.platform&&(process.env.LC_ALL="en_US.UTF-8");"atom"===e&&(process.env.PLATFORMIO_DISABLE_PROGRESSBAR="true");i&&Object.keys(i).forEach(e=>process.env[e]=i[e]);process.env.Path&&(process.env.PATH?process.env.PATH+=a.default.delimiter+process.env.Path:process.env.PATH=process.env.Path);process.env.PATH=t?[(0,n.getEnvBinDir)(),(0,n.getEnvDir)(),process.env.PATH].join(a.default.delimiter):process.env.PATH.split(a.default.delimiter).filter(e=>!e.includes((0,n.getEnvDir)())).join(a.default.delimiter);r&&!process.env.PATH.includes(r)&&(process.env.PATH=[r,process.env.PATH].join(a.default.delimiter));const o=/\%([^\%]+)\%/g;for(;h&&o.test(process.env.PATH);)process.env.PATH=process.env.PATH.replace(o,(e,t)=>process.env[t]||"");process.env.Path&&(process.env.Path=process.env.PATH);process.env.NO_PROXY="127.0.0.1"+(process.env.NO_PROXY?`,${process.env.NO_PROXY}`:"")},t.runCommand=m,t.processHTTPRequest=function(e,t,r){(r=r||{}).url=e,r.headers||(r.headers={"User-Agent":"PlatformIO"});return console.info("processHTTPRequest",r),(0,l.default)(r,(e,r,n)=>t(e,r,n))},t.getPythonExecutable=async function(e=!0,t){const r=h?["python.exe"]:["python3","python","python2"],o=t||[];e&&(o.push((0,n.getEnvBinDir)()),o.push((0,n.getEnvDir)()));h&&o.push(a.default.join((0,n.getCoreDir)(),"python37"));process.env.PATH.split(a.default.delimiter).forEach(e=>{o.includes(e)||o.push(e)});const s=a.default.join((0,n.getCacheDir)(),"check-python.py");i.default.writeFile(s,d,e=>{e&&console.error(e)});for(const e of o)for(const t of r){const r=a.default.normalize(a.default.join(e,t)).replace(/"/g,"");if(i.default.existsSync(r)&&await v(r,s))return r}return},t.getErrorReportUrl=function(e,t){const r=[["System: Darwin, 19.0.0","https://github.com/platformio/platformio-vscode-ide/issues/1108"],["WindowsError: [Error 5]","https://github.com/platformio/platformio-vscode-ide/issues/884"],["Could not start PIO Home server: Error: timeout","https://github.com/platformio/platformio-vscode-ide/issues/205"],["Failed to download file","https://github.com/platformio/platformio-vscode-ide/issues/386"],["Conda Virtualenv","https://github.com/platformio/platformio-vscode-ide/issues/914"],["ModuleNotFoundError: No module named 'distutils","https://github.com/platformio/platformio-vscode-ide/issues/907"]];for(const e of r)if(t.includes(e[0]))return e[1];return`https://github.com/platformio/platformio-${process.env.PLATFORMIO_CALLER||"vscode"}-ide/issues/new?${u.default.stringify({title:e,body:t,labels:"auto"})}`},t.isPIOProject=function(e){return o.default.isFileSync(a.default.join(e,"platformio.ini"))},t.arrayRemove=function(e,t){return e.splice(e.indexOf(t),1)},t.disposeSubscriptions=function(e){for(;e.length;)e.pop().dispose()},t.reportError=function(e){const t={v:1,tid:"UA-1768265-13",cid:y(),aid:"node.helpers",av:"5.2.0",an:`${s.default.type()}, ${s.default.release()}, ${s.default.arch()}`,t:"exception",exd:e.toString(),exf:1};process.env.PLATFORMIO_CALLER&&(t.cd1=process.env.PLATFORMIO_CALLER);l.default.post("https://www.google-analytics.com/collect",{body:u.default.stringify(t)})};var n=r(2),i=p(r(5)),o=p(r(3)),s=p(r(6)),a=p(r(1)),u=p(r(7)),l=p(r(4)),c=p(r(15)),f=p(r(8));function p(e){return e&&e.__esModule?e:{default:e}}const d='\nimport os\nimport sys\n\n\nIS_WINDOWS = sys.platform.lower().startswith("win")\nPYTHON_EXE = sys.executable\nCHECK_HTTPS_URLS = ["https://github.com", "https://platformio.org"]\n\n\ndef check_min_version():\n    assert (\n        sys.version_info >= (2, 7, 9) and sys.version_info < (3,)\n    ) or sys.version_info >= (3, 5)\n\n\ndef check_win_custom():\n    assert not any(s in PYTHON_EXE.lower() for s in ("msys", "mingw", "emacs"))\n    assert os.path.isdir(os.path.join(sys.prefix, "Scripts")) or (\n        sys.version_info >= (3, 5) and __import__("venv")\n    )\n\n\ndef check_urllib_ssl():\n    for url in CHECK_HTTPS_URLS:\n        if url_status_ok(url):\n            return True\n    return False\n\n\ndef url_status_ok(url):\n    for f in (\n        urllib_url_status_ok,\n        urllib3_url_status_ok,\n        requests_url_status_ok,\n    ):\n        try:\n            assert f(url)\n            return True\n        except Exception as e:\n            print(e)\n    return False\n\n\ndef urllib_url_status_ok(url):\n    try:\n        from urllib.request import urlopen\n    except ImportError:\n        from urllib import urlopen\n    try:\n        return int(urlopen(url).getcode()) == 200\n    except:\n        return False\n\n\ndef urllib3_url_status_ok(url):\n    import urllib3\n\n    try:\n        return int(urllib3.PoolManager().request("GET", url).status) == 200\n    except:\n        return False\n\n\ndef requests_url_status_ok(url):\n    import requests\n\n    r = requests.get(url)\n    r.raise_for_status()\n    return True\n\n\nif __name__ == "__main__":\n    # we do not support cygwin\n    assert sys.platform != "cygwin"\n\n    check_min_version()\n\n    if IS_WINDOWS:\n        check_win_custom()\n\n    assert check_urllib_ssl()\n\n    print(PYTHON_EXE)\n    sys.exit(0)\n\n',h=t.IS_WINDOWS=process.platform.startsWith("win");function m(e,t,r,i={}){console.info("runCommand",e,t,i);const s=[],u=[];let l=!1,p=null;if(i.spawnOptions=i.spawnOptions||{},!i.spawnOptions.cwd&&o.default.isDirectorySync((0,n.getEnvBinDir)())&&(i.spawnOptions.cwd=(0,n.getEnvBinDir)()),h&&["pip","virtualenv"].some(r=>[a.default.basename(e),...t].includes(r))){const e=Object.assign({},process.env);p=f.default.dirSync({dir:(0,n.getCacheDir)(),unsafeCleanup:!0}).name,e.TMPDIR=e.TEMP=e.TMP=p,i.spawnOptions.env=e,i.spawnOptions.cwd=p}try{const r=(0,c.default)(e,t,i.spawnOptions);r.stdout.on("data",e=>s.push(e)),r.stderr.on("data",e=>u.push(e)),r.on("close",d),r.on("error",e=>{u.push(e.toString()),d(-1)})}catch(e){u.push(e.toString()),d(-1)}function d(e){if(l||!r)return;if(l=!0,p)try{o.default.removeSync(p)}catch(e){console.warn(e)}const t=s.map(e=>e.toString()).join(""),n=u.map(e=>e.toString()).join("");r(e,t,n)}}function v(e,t){return new Promise(r=>{m(e,[t],(e,t,n)=>{console.info(t),n&&console.warn(n),r(0===e)})})}function y(){const e=()=>Math.floor(65536*(1+Math.random())).toString(16).substring(1);return`${e()}${e()}-${e()}-${e()}-${e()}-${e()}${e()}${e()}`}},function(e,t){e.exports=require("path")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getCoreDir=a,t.getEnvDir=u,t.getEnvBinDir=function(){return o.default.join(u(),n.IS_WINDOWS?"Scripts":"bin")},t.getCacheDir=function(){const e=o.default.join(a(),".cache");i.default.isDirectorySync(e)||i.default.makeTreeSync(e);return e},t.getVersion=function(){return new Promise((e,t)=>{(0,n.runCommand)("platformio",["--version"],(r,n,i)=>{if(0===r)try{return e(n.trim().match(/[\d+\.]+.*$/)[0])}catch(e){return t(e.toString())}return t(new Error(i))})})},t.runPIOCommand=function(e,t,r={}){const i=["-f"];process.env.PLATFORMIO_CALLER&&(i.push("-c"),i.push(process.env.PLATFORMIO_CALLER));(0,n.runCommand)("platformio",[...i,...e],t,r)};var n=r(0),i=s(r(3)),o=s(r(1));function s(e){return e&&e.__esModule?e:{default:e}}function a(){let e=process.env.HOME||"~";n.IS_WINDOWS&&(process.env.USERPROFILE?e=process.env.USERPROFILE:process.env.HOMEPATH&&(e=o.default.join(process.env.HOMEDRIVE||"",process.env.HOMEPATH)));const t=process.env.PLATFORMIO_CORE_DIR||process.env.PLATFORMIO_HOME_DIR||o.default.join(e,".platformio");if(!n.IS_WINDOWS)return t;const r=o.default.parse(t),s=o.default.format({root:r.root,dir:r.root,base:".platformio",name:".platformio"});if(i.default.isDirectorySync(s))return s;for(const e of t)if(e.charCodeAt(0)>127)return s;return t}function u(){return"PLATFORMIO_PENV_DIR"in process.env?process.env.PLATFORMIO_PENV_DIR:o.default.join(a(),"penv")}},function(t,r){t.exports=e},function(e,r){e.exports=t},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("os")},function(e,t){e.exports=r},function(e,t){e.exports=n},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getFrontendUri=function(e,t,r){const n=(D()||{}).storage||{},i={start:r.start||"/",theme:n.theme||r.theme,workspace:n.workspace||r.workspace,sid:w};return Object.keys(i).forEach(e=>{[void 0,null].includes(i[e])&&delete i[e]}),`http://${e}:${t}?${l.default.stringify(i)}`},t.getFrontendVersion=O,t.isServerStarted=E,t.ensureServerStarted=async function(e={}){let t=0,r=void 0;for(;t<3;){try{return await T(e)}catch(e){r=e,console.warn(e),P=0,await I()}t++}throw(0,i.reportError)(r),r},t.shutdownServer=function(){if(!P)return;return c.default.get(`http://${y}:${P}?__shutdown__=1`)},t.shutdownAllServers=I,t.loadState=D,t.showAtStartup=function(e){const t=D();return!t||!t.storage||!t.storage.showOnStartup||!(e in t.storage.showOnStartup)||t.storage.showOnStartup[e]};var n=r(2),i=r(0),o=r(10),s=h(r(3)),a=h(r(18)),u=h(r(1)),l=h(r(7)),c=h(r(4)),f=h(r(11)),p=h(r(19)),d=h(r(20));function h(e){return e&&e.__esModule?e:{default:e}}const m=300,v=3600,y="127.0.0.1",_=8010,g=8050,w=Math.round(1e6*Math.random());let P=0,b=0;async function O(e,t){return await new Promise(r=>{(0,c.default)(`http://${e}:${t}/package.json`,(function(e,t,n){if(e||!t||200!==t.statusCode)return r(void 0);try{return r(JSON.parse(n).version)}catch(e){}return r(void 0)}))})}async function S(e,t){return new Promise(r=>{p.default.check(t,e).then(e=>r(e),()=>r(!1))})}async function E(){return!!await S(y,P)&&!!await O(y,P)}async function T(e={}){0===P&&(P=e.port||await async function(){let e=_;for(;e<g;){if(!await S(y,e))return e;if(await O(y,e))return e;e++}return 0}());const t={host:y,port:P};return await E()||await new Promise((e,t)=>{(0,n.runPIOCommand)(["home","--port",P,"--shutdown-timeout",v,"--no-open"],(e,r,n)=>{if(0!==e)return P=0,t(new Error(n))}),p.default.waitUntilUsed(P,500,1e3*m).then(()=>{e(!0)},e=>{t(new Error("Could not start PIO Home server: "+e.toString()))})}),e.onIDECommand&&async function(e){if(b>0)return;let t="0.0.0";const r=Math.random().toString(),n=new d.default(`ws://${y}:${P}/wsrpc`,{perMessageDeflate:!1});n.onopen=()=>{b=1,n.send(JSON.stringify(a.default.request(r,"core.version")))},n.onclose=()=>{b=0},n.onmessage=i=>{try{const n=a.default.parse(i.data);switch(n.type){case"success":n.payload.id===r?t=(0,o.PEPverToSemver)(n.payload.result):e(n.payload.result.method,n.payload.result.params);break;case"error":console.error("Errored result: "+n.payload.toString())}}catch(e){console.error("Invalid RPC message: "+e.toString())}let s=null;s=f.default.gte(t,"4.0.1")?a.default.request(Math.random().toString(),"ide.listen_commands",[w]):a.default.request(Math.random().toString(),"ide.listen_commands"),n.send(JSON.stringify(s))}}(e.onIDECommand),t}async function I(){let e=_;for(;e<g;)c.default.get(`http://${y}:${e}?__shutdown__=1`).on("error",()=>{}),e++;await(0,i.sleep)(2e3)}function D(){const e=u.default.join((0,n.getCoreDir)(),"homestate.json");if(!s.default.isFileSync(e))return null;try{return JSON.parse(s.default.readFileSync(e,"utf8"))}catch(e){return console.warn(e),null}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.download=async function(e,t,r=3){const n=await(o=e,new Promise(e=>{i.default.head({url:o},(t,r)=>{!t&&200===r.statusCode&&r.headers&&r.headers["content-length"]||e(-1),e(parseInt(r.headers["content-length"]))})}));var o;if(l(t,n))return t;let s="";for(;r>=0;){try{if(await c(e,t),l(t,n))return t}catch(e){s=e,console.warn(e)}r--}throw new Error(`Failed to download file ${e}: ${s}`)},t.extractTarGz=function(e,t){return new Promise((r,i)=>{n.default.createReadStream(e).pipe(a.default.createGunzip()).on("error",e=>i(e)).pipe(s.default.extract({cwd:t})).on("error",e=>i(e)).on("close",()=>r(t))})},t.PEPverToSemver=function(e){return e.replace(/(\.\d+)\.?(dev|a|b|rc|post)/,"$1-$2.")};var n=u(r(3)),i=u(r(4)),o=r(0),s=u(r(16)),a=u(r(17));function u(e){return e&&e.__esModule?e:{default:e}}function l(e,t){if(n.default.isFileSync(e)){if(t>0&&t==n.default.getSizeSync(e))return!0;try{n.default.removeSync(e)}catch(e){console.warn(e)}}return!1}async function c(e,t){let r=null;try{const e=atom.packages.getApmPath();r=await new Promise((t,r)=>{(0,o.runCommand)(e,["--no-color","config","get","https-proxy"],(e,n)=>{if(0!==e)return r(null);t("null"===n.trim()?null:n.trim())})})}catch(e){r=process.env.HTTPS_PROXY&&process.env.HTTPS_PROXY.trim()||process.env.HTTP_PROXY&&process.env.HTTP_PROXY.trim()}return new Promise((o,s)=>{const a=n.default.createWriteStream(t),u={url:e};r&&(u.proxy=r),i.default.get(u).on("error",e=>s(e)).pipe(a),a.on("error",e=>s(e)),a.on("finish",()=>o(t))})}},function(e,t){e.exports=i},function(e,t,r){"use strict";function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function i(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}Object.defineProperty(t,"__esModule",{value:!0});let o=function(){function e(t,r,n={}){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.stateStorage=t,this.onStatusChange=r,this.params=n,this._status=e.STATUS_CHECKING}var t,r,i;return t=e,(r=[{key:"check",value:function(){throw new Error("Stage must implement a `check` method")}},{key:"install",value:function(){throw new Error("Stage must implement an `install` method")}},{key:"destroy",value:function(){}},{key:"name",get:function(){return"Stage"}},{key:"status",get:function(){return this._status},set:function(e){this._status=e,this.onStatusChange()}},{key:"stateKey",get:function(){return this.name.toLocaleLowerCase().replace(/\s+/g,"-")}},{key:"state",get:function(){return this.stateStorage.getValue(this.stateKey)},set:function(e){this.stateStorage.setValue(this.stateKey,e)}}])&&n(t.prototype,r),i&&n(t,i),e}();i(o,"STATUS_CHECKING",0),i(o,"STATUS_INSTALLING",1),i(o,"STATUS_SUCCESSED",2),i(o,"STATUS_FAILED",3),t.default=o},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n,i=r(0),o=r(1),s=(n=o)&&n.__esModule?n:{default:n},a=r(2);function u(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}let l=function(){function e(t,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.projectDir=t,this.options=r,this.subscriptions=[],this.dirWatchSubscriptions=[],this._rebuildTimeout=void 0,this._updateDirWatchersTimeout=void 0,this._inProgress=!1,this.setupWatchers()}var t,r,n;return t=e,(r=[{key:"requestRebuild",value:function(){this._rebuildTimeout&&clearTimeout(this._rebuildTimeout),this._rebuildTimeout=setTimeout(this.rebuild.bind(this),e.AUTO_REBUILD_DELAY)}},{key:"rebuild",value:function(){if(!this._inProgress&&(0,i.isPIOProject)(this.projectDir))return this.options.withProgress(async()=>{this._inProgress=!0;try{await new Promise((e,t)=>{(0,a.runPIOCommand)(["init","--ide",this.options.ide,"--project-dir",this.projectDir],(r,n,i)=>{0===r?e():t(new Error(i))})})}catch(e){console.warn(e)}this._inProgress=!1})}},{key:"setupWatchers",value:function(){const e=this.options.createFileSystemWatcher(s.default.join(this.projectDir,"platformio.ini"));this.subscriptions.push(e,e.onDidCreate(()=>{this.requestRebuild(),this.requestUpdateDirWatchers()}),e.onDidChange(()=>{this.requestRebuild(),this.requestUpdateDirWatchers()}),e.onDidDelete(()=>this.updateDirWatchers())),this.requestUpdateDirWatchers()}},{key:"requestUpdateDirWatchers",value:function(){this._updateDirWatchersTimeout&&clearTimeout(this._updateDirWatchersTimeout),this._updateDirWatchersTimeout=setTimeout(this.updateDirWatchers.bind(this),3*e.AUTO_REBUILD_DELAY)}},{key:"updateDirWatchers",value:async function(){if((0,i.disposeSubscriptions)(this.dirWatchSubscriptions),(0,i.isPIOProject)(this.projectDir))try{(await this.fetchWatchDirs()).forEach(e=>{const t=this.options.createDirSystemWatcher(e);this.dirWatchSubscriptions.push(t,t.onDidCreate(()=>this.requestRebuild()),t.onDidChange(()=>this.requestRebuild()),t.onDidDelete(()=>this.requestRebuild()))})}catch(e){console.warn(e)}}},{key:"fetchWatchDirs",value:async function(){e.PythonExecutable||(e.PythonExecutable=await(0,i.getPythonExecutable)(this.options.useBuiltinPIOCore));const t=["import os","from platformio.project import helpers","libdeps_dir = helpers.get_project_libdeps_dir()","watch_dirs = [helpers.get_project_global_lib_dir(), helpers.get_project_lib_dir(), libdeps_dir]","watch_dirs.extend(os.path.join(libdeps_dir, d) for d in (os.listdir(libdeps_dir) if os.path.isdir(libdeps_dir) else []) if os.path.isdir(os.path.join(libdeps_dir, d)))",'print(":".join(watch_dirs))'];return new Promise((r,n)=>{(0,i.runCommand)(e.PythonExecutable,["-c",t.join(";")],(e,t,i)=>{0===e?r(t.toString().trim().split(":")):n(new Error(i))},{spawnOptions:{cwd:this.projectDir}})})}},{key:"dispose",value:function(){(0,i.disposeSubscriptions)(this.dirWatchSubscriptions),(0,i.disposeSubscriptions)(this.subscriptions),this._rebuildTimeout&&clearTimeout(this._rebuildTimeout),this._updateDirWatchersTimeout&&clearTimeout(this._updateDirWatchersTimeout)}}])&&u(t.prototype,r),n&&u(t,n),e}();!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(l,"AUTO_REBUILD_DELAY",3e3),t.default=l},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.misc=t.project=t.installer=t.home=t.core=void 0;var n=d(r(2)),i=d(r(9)),o=d(r(0)),s=r(21),a=f(r(12)),u=f(r(24)),l=f(r(13)),c=f(r(25));function f(e){return e&&e.__esModule?e:{default:e}}function p(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return p=function(){return e},e}function d(e){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=p();if(t&&t.has(e))return t.get(e);var r={},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var i in e)if(Object.prototype.hasOwnProperty.call(e,i)){var o=n?Object.getOwnPropertyDescriptor(e,i):null;o&&(o.get||o.set)?Object.defineProperty(r,i,o):r[i]=e[i]}return r.default=e,t&&t.set(e,r),r}const h={BaseStage:a.default,PlatformIOCoreStage:u.default},m={ProjectIndexer:l.default,ProjectObserver:c.default,ProjectTasks:s.ProjectTasks,TaskItem:s.TaskItem};t.core=n,t.home=i,t.installer=h,t.project=m,t.misc=o},function(e,t){e.exports=o},function(e,t){e.exports=s},function(e,t){e.exports=require("zlib")},function(e,t){e.exports=a},function(e,t){e.exports=u},function(e,t){e.exports=l},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TaskItem=t.ProjectTasks=void 0;var n=o(r(22)),i=o(r(1));function o(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function u(e,t,r){return t&&a(e.prototype,t),r&&a(e,r),e}let l=t.ProjectTasks=function(){function e(t,r){s(this,e),this.projectDir=t,this.ide=r}return u(e,[{key:"getTasks",value:async function(){if(!this.projectDir)return[];const t=[],r=process.cwd();process.chdir(this.projectDir);try{const e=new n.default(i.default.join(this.projectDir,"platformio.ini"));for(const r of e.envs()){const n=e.get(`env:${r}`,"platform");n&&t.push({env:r,platform:n})}}catch(e){return console.warn(`Could not parse "platformio.ini" file in ${this.projectDir}: ${e}`),[]}process.chdir(r);const o=[];return e.baseTasks.forEach(e=>{e.filter&&!t.some(t=>e.filter(t))||o.push(new d(e.name,e.description,e.args.slice(0)))}),t.length>1&&t.forEach(t=>{e.baseTasks.forEach(e=>{!e.multienv||e.filter&&!e.filter(t)||o.push(new d(e.name,e.description,[...e.args.slice(0),"--environment",t.env]))})}),o.push(new d("Update project libraries",void 0,["lib","update"])),o.push(new d("Rebuild IntelliSense Index",void 0,["init","--ide",this.ide])),o}}]),e}();var c,f,p;p=[{name:"Build",args:["run"],multienv:!0},{name:"Upload",args:["run","--target","upload"],multienv:!0},{name:"Monitor",args:["device","monitor"],multienv:!0},{name:"Upload and Monitor",args:["run","--target","upload","--target","monitor"],multienv:!0,filter:e=>!e.platform.includes("riscv_gap")},{name:"Upload using Programmer",args:["run","--target","program"],multienv:!0,filter:e=>e.platform.includes("atmelavr")},{name:"Set Fuses",args:["run","--target","fuses"],multienv:!0,filter:e=>e.platform.includes("atmelavr")},{name:"Upload and Set Fuses",args:["run","--target","fuses","--target","upload"],multienv:!0,filter:e=>e.platform.includes("atmelavr")},{name:"Upload using Programmer and Set Fuses",args:["run","--target","fuses","--target","program"],multienv:!0,filter:e=>e.platform.includes("atmelavr")},{name:"Upload File System image",args:["run","--target","uploadfs"],multienv:!0,filter:e=>e.platform.includes("espressif")||e.platform.includes("riscv_gap")},{name:"Erase Flash",args:["run","--target","erase"],multienv:!0,filter:e=>e.platform.includes("espressif")||e.platform.includes("nordicnrf")},{name:"Devices",args:["device","list"]},{name:"Test",args:["test"],multienv:!0},{name:"Check",args:["check"],multienv:!0},{name:"Pre-Debug",description:"build in debug mode",args:["debug"],multienv:!0},{name:"Clean",args:["run","--target","clean"],multienv:!0},{name:"Verbose Build",args:["run","--verbose"],multienv:!0},{name:"Verbose Upload",args:["run","--verbose","--target","upload"],multienv:!0},{name:"Remote Upload",args:["remote","run","--target","upload"],multienv:!0},{name:"Remote Monitor",args:["remote","device","monitor"]},{name:"Remote Devices",args:["remote","device","list"]},{name:"Remote Test",args:["remote","test"],multienv:!0}],(f="baseTasks")in(c=l)?Object.defineProperty(c,f,{value:p,enumerable:!0,configurable:!0,writable:!0}):c[f]=p;let d=t.TaskItem=function(){function e(t,r,n){s(this,e),this.name=t,this.description=r,this.args=n}return u(e,[{key:"isBuild",value:function(){return this.name.startsWith("Build")}},{key:"isClean",value:function(){return this.name.startsWith("Clean")}},{key:"isTest",value:function(){return this.name.startsWith("Test")}},{key:"coreTarget",get:function(){if("run"!==this.args[0])return this.args[0];const e=this.args.indexOf("--target");return-1!==e?this.args[e+1]:"build"}},{key:"coreEnv",get:function(){const e=this.args.indexOf("--environment");return-1!==e?this.args[e+1]:void 0}},{key:"id",get:function(){let e=this.name;return this.coreEnv&&(e+=` (${this.coreEnv})`),e}},{key:"title",get:function(){return this.description?`${this.id} [${this.description}]`:this.id}}]),e}()},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n=o(r(5)),i=o(r(23));function o(e){return e&&e.__esModule?e:{default:e}}function s(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function a(e,t,r){return t&&s(e.prototype,t),r&&s(e,r),e}function u(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}let l=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),u(this,"reLines",/[\r\n]+/g),u(this,"reComment",/(^\s*;|\s+;|^\s*#).+/),u(this,"reSection",/^\[([^\]]+)\]/),u(this,"reOptionValue",/^([^=]+)=(.*)/),u(this,"reMultiLineValue",/^\s+(.*)/),u(this,"reInterpolation",/\$\{([^\.\}]+)\.([^\}]+)\}/g),this.path=t,this._parsed=[],this._data={},t&&this.read(t)}return a(e,null,[{key:"parse_multi_values",value:function(e){const t=[];if(!e)return t;"string"==typeof e&&(e=e.split(e.includes("\n")?"\n":", "));for(let r of e)(r=r.trim())&&t.push(r);return t}}]),a(e,[{key:"read",value:function(e){if(this._parsed.includes(e))return;this._parsed.push(e);let t=null,r=null;for(let i of n.default.readFileSync(e,"utf-8").split(this.reLines)){if(!(i=i.replace(this.reComment,"")))continue;const e=i.match(this.reSection);if(e){t=e[1],this._data[t]||(this._data[t]={}),r=null;continue}const n=i.match(this.reOptionValue);if(t&&n){r=n[1].trim(),this._data[t][r]=n[2].trim();continue}const o=i.match(this.reMultiLineValue);r&&o&&(this._data[t][r]+="\n"+o[0])}this.getlist("platformio","extra_configs").forEach(e=>i.default.sync(e).forEach(e=>this.read(e)))}},{key:"getraw",value:function(e,t){if(!this._data[e])throw`NoSectionError: ${e}`;let r=null;if(t in this._data[e])r=this._data[e][t];else{if(!e.startsWith("env:"))throw`NoOptionError: ${e} -> ${t}`;r=this.get("env",t)}return r.includes("${")&&r.includes("}")?r.replace(this.reInterpolation,(e,t,r)=>this._reInterpolationHandler(t,r)):r}},{key:"_reInterpolationHandler",value:function(e,t){return"sysenv"==e?process.env[t]||"":this.get(e,t)}},{key:"sections",value:function(){return Object.keys(this._data)}},{key:"envs",value:function(){return this.sections().filter(e=>e.startsWith("env:")).map(e=>e.substring(4))}},{key:"get",value:function(e,t,r){try{return this.getraw(e,t)}catch(e){return r}}},{key:"getlist",value:function(t,r,n){return e.parse_multi_values(this.get(t,r,n))}}]),e}();t.default=l},function(e,t){e.exports=c},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n=m(r(2)),i=m(r(10)),o=m(r(9)),s=m(r(0)),a=d(r(12)),u=d(r(3)),l=d(r(6)),c=d(r(1)),f=d(r(11)),p=d(r(8));function d(e){return e&&e.__esModule?e:{default:e}}function h(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return h=function(){return e},e}function m(e){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=h();if(t&&t.has(e))return t.get(e);var r={},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var i in e)if(Object.prototype.hasOwnProperty.call(e,i)){var o=n?Object.getOwnPropertyDescriptor(e,i):null;o&&(o.get||o.set)?Object.defineProperty(r,i,o):r[i]=e[i]}return r.default=e,t&&t.set(e,r),r}function v(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function y(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function _(e){return(_=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function g(e,t){return(g=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function w(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}let P=function(e){function t(){var e;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),e=y(this,_(t).apply(this,arguments)),p.default.setGracefulCleanup(),e._skipPIPInstalling=!1,e}var r,l,d;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&g(e,t)}(t,e),r=t,(l=[{key:"whereIsPython",value:async function(){let e=this.params.pythonPrompt.STATUS_TRY_AGAIN;do{const t=await s.getPythonExecutable(this.params.useBuiltinPIOCore);if(t)return t;if(process.platform.startsWith("win"))try{return await this.installPythonForWindows()}catch(e){console.warn(e)}const r=await this.params.pythonPrompt.prompt();if((e=r.status)===this.params.pythonPrompt.STATUS_CUSTOMEXE)return r.pythonExecutable}while(e!==this.params.pythonPrompt.STATUS_ABORT);throw this.status=a.default.STATUS_FAILED,new Error("Can not find Python Interpreter. Please install Python 3.5 or above manually")}},{key:"installPythonForWindows",value:async function(){const e="x64"===process.arch?"-amd64":"",r=`https://www.python.org/ftp/python/${t.pythonVersion}/python-${t.pythonVersion}${e}.exe`,o=await i.download(r,c.default.join(n.getCacheDir(),c.default.basename(r))),s=c.default.join(n.getCoreDir(),"python37");let a=c.default.join(s,"python.exe");return u.default.isFileSync(a)||(a=await this.installPythonFromWindowsInstaller(o,s),this._skipPIPInstalling=!0),process.env.PATH=[s,c.default.join(s,"Scripts"),process.env.PATH].join(c.default.delimiter),process.env.Path=process.env.PATH,a}},{key:"installPythonFromWindowsInstaller",value:function(e,t){if(u.default.isDirectorySync(t))try{u.default.removeSync(t)}catch(e){console.warn(e)}const r=c.default.join(n.getCacheDir(),"python-installer.log");return new Promise((n,i)=>{s.runCommand(e,["/quiet","/log",r,"SimpleInstall=1","InstallAllUsers=0","InstallLauncherAllUsers=0","Shortcuts=0","Include_lib=1","Include_pip=1","Include_doc=0","Include_launcher=0","Include_test=0","Include_tcltk=0",`TargetDir=${t}`,`DefaultAllUsersTargetDir=${t}`,`DefaultJustForMeTargetDir=${t}`],e=>0===e&&u.default.isFileSync(c.default.join(t,"python.exe"))?n(c.default.join(t,"python.exe")):(u.default.isFileSync(r)&&console.error(u.default.readFileSync(r).toString()),i(new Error("Could not install Python 3 automatically. Please install it manually from https://python.org"))),{spawnOptions:{shell:!0}})})}},{key:"cleanVirtualEnvDir",value:function(){const e=n.getEnvDir();if(!u.default.isDirectorySync(e))return!0;try{return u.default.removeSync(e),!0}catch(e){return console.warn(e),!1}}},{key:"isCondaInstalled",value:function(){return new Promise(e=>{s.runCommand("conda",["--version"],t=>e(0===t))})}},{key:"createVirtualenvWithConda",value:function(){return this.cleanVirtualEnvDir(),new Promise((e,t)=>{s.runCommand("conda",["create","--yes","--quiet","python=2","pip","--prefix",n.getEnvDir()],(r,n,i)=>0===r?e(n):t(new Error(`Conda Virtualenv: ${i}`)))})}},{key:"createVirtualenvWithLocal",value:async function(){this.cleanVirtualEnvDir();const e=await this.whereIsPython(),t=[[e,"-m","venv",n.getEnvDir()],[e,"-m","virtualenv","-p",e,n.getEnvDir()],["virtualenv","-p",e,n.getEnvDir()],[e,"-m","virtualenv",n.getEnvDir()],["virtualenv",n.getEnvDir()]];let r=null;for(const e of t){this.cleanVirtualEnvDir();try{return await new Promise((t,r)=>{s.runCommand(e[0],e.slice(1),(e,n,i)=>0===e?t(n):r(new Error(`User's Virtualenv: ${i}`)))})}catch(e){console.warn(e),r=e}}throw r}},{key:"createVirtualenvWithDownload",value:async function(){this.cleanVirtualEnvDir();const e=await i.download(t.virtualenvUrl,c.default.join(n.getCacheDir(),"virtualenv.tar.gz")),r=p.default.dirSync({dir:n.getCacheDir(),unsafeCleanup:!0}).name,o=await i.extractTarGz(e,r),a=u.default.listTreeSync(o).find(e=>"virtualenv.py"===c.default.basename(e));if(!a)throw new Error("Can not find virtualenv.py script");const l=await this.whereIsPython();return new Promise((e,t)=>{s.runCommand(l,[a,n.getEnvDir()],(n,i,o)=>{try{u.default.removeSync(r)}catch(e){console.warn(e)}if(0===n)return e(i);{let e=`Virtualenv Create: ${o}\n${i}`;return o.includes("WindowsError: [Error 5]")&&(e=`If you use Antivirus, it can block PlatformIO Installer. Try to disable it for a while.\n\n${e}`),t(new Error(e))}})})}},{key:"installVirtualenvPackage",value:async function(){const e=await this.whereIsPython();return new Promise((t,r)=>{s.runCommand(e,["-m","pip","install","virtualenv"],(e,n,i)=>0===e?t(n):r(new Error(`Install Virtualenv globally: ${i}`)))})}},{key:"createVirtualenv",value:async function(){if(await this.isCondaInstalled())return await this.createVirtualenvWithConda();try{await this.createVirtualenvWithLocal()}catch(e){console.warn(e);try{await this.createVirtualenvWithDownload()}catch(e){console.warn(e);try{await this.installVirtualenvPackage(),await this.createVirtualenvWithLocal()}catch(t){throw s.reportError(e),console.warn(t),new Error(`Could not create PIO Core Virtual Environment. Please create it manually -> http://bit.ly/pio-core-virtualenv \n ${e.toString()}`)}}}}},{key:"installPIP",value:async function(e){if(u.default.writeFileSync(c.default.join(n.getEnvDir(),"pip.conf"),["[global]","user=no"].join("\n")),this._skipPIPInstalling)return;const r=await i.download(t.getPipUrl,c.default.join(n.getCacheDir(),c.default.basename(t.getPipUrl)));return new Promise((t,n)=>{s.runCommand(e,[r],(e,r,i)=>0===e?t(r):n(i))})}},{key:"installPIOCore",value:async function(){const e=await this.whereIsPython();try{await this.installPIP(e)}catch(e){console.warn(e),s.reportError(new Error(`Installing PIP: ${e.toString()}`))}const r=["-m","pip","install","-U"];return this.params.useDevelopmentPIOCore?r.push(t.pioCoreDevelopUrl):r.push("platformio"),new Promise((t,n)=>{s.runCommand(e,r,(e,r,i)=>{if(0!==e)return s.IS_WINDOWS&&(i=`If you have antivirus/firewall/defender software in a system, try to disable it for a while. \n ${i}`),n(new Error(`PIP Core: ${i}`));t(r)})})}},{key:"installPIOHome",value:function(){return new Promise(e=>{n.runPIOCommand(["home","--host","__do_not_start__"],(t,r,n)=>(0!==t&&console.warn(r,n),e(!0)))})}},{key:"initState",value:function(){let e=this.state;return e&&e.pioCoreChecked&&e.lastIDEVersion||(e={pioCoreChecked:0,lastIDEVersion:null}),e}},{key:"autoUpgradePIOCore",value:async function(e){const r=this.initState(),i=(new Date).getTime();(process.env.PLATFORMIO_IDE&&r.lastIDEVersion&&r.lastIDEVersion!==process.env.PLATFORMIO_IDE||i-t.UPGRADE_PIOCORE_TIMEOUT>parseInt(r.pioCoreChecked))&&(r.pioCoreChecked=i,await new Promise(t=>{n.runPIOCommand(["upgrade",...this.params.useDevelopmentPIOCore&&!f.default.prerelease(e)?["--dev"]:[]],(e,r,n)=>{0!==e&&console.warn(r,n),t(!0)})})),r.lastIDEVersion=process.env.PLATFORMIO_IDE,this.state=r}},{key:"checkPenvLocked",value:function(){const e=c.default.join(n.getEnvDir(),t.PENV_LOCK_FILE_NAME);if(u.default.isFileSync(e)){if(u.default.readFileSync(e).toString().trim()!==t.PENV_LOCK_VERSION.trim())throw new Error("Virtual environment is outdated");return!0}}},{key:"lockPenvDir",value:function(){u.default.writeFileSync(c.default.join(n.getEnvDir(),t.PENV_LOCK_FILE_NAME),t.PENV_LOCK_VERSION)}},{key:"check",value:async function(){const e=i.PEPverToSemver(await n.getVersion());if(this.params.useBuiltinPIOCore){if(!u.default.isDirectorySync(n.getEnvBinDir()))throw new Error("Virtual environment is not created");this.checkPenvLocked();try{await this.autoUpgradePIOCore(e)}catch(e){console.warn(e)}}if(f.default.lt(e,this.params.pioCoreMinVersion))throw this.params.setUseBuiltinPIOCore(!0),this.params.useBuiltinPIOCore=!0,this.params.useDevelopmentPIOCore=this.params.useDevelopmentPIOCore||f.default.prerelease(this.params.pioCoreMinVersion),new Error(`Incompatible PIO Core ${e}`);return this.status=a.default.STATUS_SUCCESSED,console.info(`Found PIO Core ${e}`),!0}},{key:"install",value:async function(){if(this.status===a.default.STATUS_SUCCESSED)return!0;if(!this.params.useBuiltinPIOCore)return this.status=a.default.STATUS_SUCCESSED,!0;this.status=a.default.STATUS_INSTALLING;try{await o.shutdownAllServers(),await this.createVirtualenv(),this.lockPenvDir(),await this.installPIOCore(),await this.installPIOHome()}catch(e){throw s.reportError(e),e}return this.status=a.default.STATUS_SUCCESSED,!0}},{key:"name",get:function(){return"PlatformIO Core"}}])&&v(r.prototype,l),d&&v(r,d),t}(a.default);w(P,"UPGRADE_PIOCORE_TIMEOUT",6048e5),w(P,"PENV_LOCK_FILE_NAME","piopenv.lock"),w(P,"PENV_LOCK_VERSION",`${l.default.type()}-${l.default.arch()}-${l.default.release()}`),w(P,"pythonVersion","3.7.5"),w(P,"getPipUrl","https://bootstrap.pypa.io/get-pip.py"),w(P,"virtualenvUrl","https://files.pythonhosted.org/packages/e7/80/15d28e5a075fb02366ce97558120bb987868dab3600233ec7be032dc6d01/virtualenv-16.7.7.tar.gz"),w(P,"pioCoreDevelopUrl","https://github.com/platformio/platformio/archive/develop.zip"),t.default=P},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n,i=r(13),o=(n=i)&&n.__esModule?n:{default:n},s=r(0);function a(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}let u=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.options=t,this._indexers=[]}var t,r,n;return t=e,(r=[{key:"update",value:async function(e){this._indexers=this._indexers.filter(t=>!!e.includes(t.projectDir)||(t.dispose(),!1));for(const t of e){if(this._indexers.some(e=>e.projectDir===t))continue;const e=new o.default(t,this.options);this._indexers.push(e),await e.rebuild()}}},{key:"rebuildIndex",value:function(){this._indexers.forEach(e=>e.rebuild())}},{key:"dispose",value:function(){(0,s.disposeSubscriptions)(this._indexers)}}])&&a(t.prototype,r),n&&a(t,n),e}();t.default=u}])}));
//# sourceMappingURL=index.js.map