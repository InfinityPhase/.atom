!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("fs-plus"),require("request"),require("querystringify"),require("tmp"),require("cross-spawn"),require("jsonrpc-lite"),require("tcp-port-used"),require("ws"),require("ini"),require("tar"),require("semver")):"function"==typeof define&&define.amd?define("platformio-node-helpers",["fs-plus","request","querystringify","tmp","cross-spawn","jsonrpc-lite","tcp-port-used","ws","ini","tar","semver"],t):"object"==typeof exports?exports["platformio-node-helpers"]=t(require("fs-plus"),require("request"),require("querystringify"),require("tmp"),require("cross-spawn"),require("jsonrpc-lite"),require("tcp-port-used"),require("ws"),require("ini"),require("tar"),require("semver")):e["platformio-node-helpers"]=t(e["fs-plus"],e.request,e.querystringify,e.tmp,e["cross-spawn"],e["jsonrpc-lite"],e["tcp-port-used"],e.ws,e.ini,e.tar,e.semver)}(global,function(e,t,r,n,o,i,s,a,u,c,l){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=9)}([function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IS_WINDOWS=void 0,t.sleep=function(e){return new Promise(t=>setTimeout(t,e))},t.patchOSEnviron=function({caller:e,useBuiltinPIOCore:t=!0,extraPath:r,extraVars:o}){process.env.PLATFORMIO_CALLER=e,"darwin"===process.platform&&(process.env.LC_ALL="en_US.UTF-8");"atom"===e&&(process.env.PLATFORMIO_DISABLE_PROGRESSBAR="true");o&&Object.keys(o).forEach(e=>process.env[e]=o[e]);process.env.Path&&(process.env.PATH?process.env.PATH+=s.default.delimiter+process.env.Path:process.env.PATH=process.env.Path);process.env.PATH=t?[(0,n.getEnvBinDir)(),(0,n.getEnvDir)(),process.env.PATH].join(s.default.delimiter):process.env.PATH.split(s.default.delimiter).filter(e=>!e.includes((0,n.getEnvDir)())).join(s.default.delimiter);r&&!process.env.PATH.includes(r)&&(process.env.PATH=[r,process.env.PATH].join(s.default.delimiter));process.env.Path&&(process.env.Path=process.env.PATH)},t.runCommand=d,t.processHTTPRequest=function(e,t,r){(r=r||{}).url=e,r.hasOwnProperty("headers")||(r.headers={"User-Agent":"PlatformIO"});return console.info("processHTTPRequest",r),(0,u.default)(r,(e,r,n)=>t(e,r,n))},t.getPythonExecutable=async function(e=!0,t){const r=p?["python.exe"]:["python2.7","python2","python"],i=t||[];e&&(i.push((0,n.getEnvBinDir)()),i.push((0,n.getEnvDir)()));p&&i.push(s.default.join((0,n.getHomeDir)(),"python27"));process.env.PATH.split(s.default.delimiter).forEach(e=>{i.includes(e)||i.push(e)});for(const e of i)for(const t of r){const r=s.default.normalize(s.default.join(e,t)).replace(/"/g,"");if(o.default.isFileSync(r)&&await h(r))return r}return},t.getErrorReportUrl=function(e,t){const r=[["_remove_dead_weakref","https://github.com/platformio/platformio-vscode-ide/issues/142"],["Could not install 'tool-pioplus'","https://github.com/platformio/platformio-vscode-ide/issues/131"],["Could not start PIO Home server: Error: timeout","https://github.com/platformio/platformio-vscode-ide/issues/205"]];for(const e of r)if(t.includes(e[0]))return e[1];return`https://github.com/platformio/platformio-${process.env.PLATFORMIO_CALLER||"vscode"}-ide/issues/new?${a.default.stringify({title:encodeURIComponent(e),body:encodeURIComponent(t)})}`},t.isPIOProject=function(e){return o.default.isFileSync(s.default.join(e,"platformio.ini"))},t.arrayRemove=function(e,t){return e.splice(e.indexOf(t),1)},t.disposeSubscriptions=function(e){for(;e.length;)e.pop().dispose()},t.reportError=function(e){const t={v:1,tid:"UA-1768265-13",cid:function(){const e=()=>Math.floor(65536*(1+Math.random())).toString(16).substring(1);return`${e()}${e()}-${e()}-${e()}-${e()}-${e()}${e()}${e()}`}(),aid:"node.helpers",av:"4.0.0",an:`${i.default.type()}, ${i.default.release()}, ${i.default.arch()}`,t:"exception",exd:e.toString(),exf:1};process.env.PLATFORMIO_CALLER&&(t.cd1=process.env.PLATFORMIO_CALLER);u.default.post("https://www.google-analytics.com/collect",{body:a.default.stringify(t)})};var n=r(3),o=f(r(1)),i=f(r(10)),s=f(r(2)),a=f(r(5)),u=f(r(4)),c=f(r(11)),l=f(r(6));function f(e){return e&&e.__esModule?e:{default:e}}const p=t.IS_WINDOWS=process.platform.startsWith("win");function d(e,t,r,i={}){console.info("runCommand",e,t,i);const a=[],u=[];let f=!1,d=null;if(p&&["pip","virtualenv"].some(r=>[s.default.basename(e),...t].includes(r))){const e=Object.assign({},process.env);d=l.default.dirSync({dir:(0,n.getCacheDir)(),unsafeCleanup:!0}).name,e.TMPDIR=e.TEMP=e.TMP=d,i.spawnOptions=i.spawnOptions||{},i.spawnOptions.env=e}try{const r=(0,c.default)(e,t,i.spawnOptions);r.stdout.on("data",e=>a.push(e)),r.stderr.on("data",e=>u.push(e)),r.on("close",h),r.on("error",e=>{u.push(e.toString()),h(-1)})}catch(e){u.push(e.toString()),h(-1)}function h(e){if(f||!r)return;if(f=!0,d)try{o.default.removeSync(d)}catch(e){console.warn(e)}const t=a.map(e=>e.toString()).join(""),n=u.map(e=>e.toString()).join("");r(e,t,n)}}function h(e){const t=["import os, sys",'assert sys.platform != "cygwin"','assert not sys.platform.startswith("win") or not any(s in sys.executable.lower() for s in ("msys", "mingw", "emacs"))','assert not sys.platform.startswith("win") or os.path.isdir(os.path.join(sys.prefix, "Scripts"))',"assert sys.version_info < (3, 0, 0)"];p?t.push("assert sys.version_info >= (2, 7, 9)"):t.push("assert sys.version_info >= (2, 7, 5)");const r=["-c",t.join(";")];return new Promise(t=>{d(e,r,e=>{t(0===e)})})}},function(t,r){t.exports=e},function(e,t){e.exports=require("path")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getHomeDir=a,t.getEnvDir=u,t.getEnvBinDir=function(){return i.default.join(u(),n.IS_WINDOWS?"Scripts":"bin")},t.getCacheDir=function(){const e=i.default.join(a(),".cache");o.default.isDirectorySync(e)||o.default.makeTreeSync(e);return e},t.getVersion=function(){return new Promise((e,t)=>{(0,n.runCommand)("platformio",["--version"],(r,n,o)=>{if(0===r)try{return e(n.trim().match(/[\d+\.]+.*$/)[0])}catch(e){return t(e.toString())}return t(new Error(o))})})},t.runPIOCommand=function(e,t,r={}){const o=["-f"];process.env.PLATFORMIO_CALLER&&(o.push("-c"),o.push(process.env.PLATFORMIO_CALLER));(0,n.runCommand)("platformio",[...o,...e],t,r)};var n=r(0),o=s(r(1)),i=s(r(2));function s(e){return e&&e.__esModule?e:{default:e}}function a(){const e=n.IS_WINDOWS&&!process.env.HOME?process.env.USERPROFILE:process.env.HOME,t=process.env.PLATFORMIO_HOME_DIR||i.default.join(e||"~",".platformio");if(n.IS_WINDOWS)for(const e of t)if(e.charCodeAt(0)>127){const e=i.default.parse(t);return i.default.format({root:e.root,dir:e.root,base:".platformio",name:".platformio"})}return t}function u(){return i.default.join(a(),"penv")}},function(e,r){e.exports=t},function(e,t){e.exports=r},function(e,t){e.exports=n},function(e,t,r){"use strict";function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}Object.defineProperty(t,"__esModule",{value:!0});let i=function(){function e(t,r,n={}){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.stateStorage=t,this.onStatusChange=r,this.params=n,this._status=e.STATUS_CHECKING}var t,r,o;return t=e,(r=[{key:"check",value:function(){throw new Error("Stage must implement a `check` method")}},{key:"install",value:function(){throw new Error("Stage must implement an `install` method")}},{key:"destroy",value:function(){}},{key:"name",get:function(){return"Stage"}},{key:"status",get:function(){return this._status},set:function(e){this._status=e,this.onStatusChange()}},{key:"stateKey",get:function(){return this.name.toLocaleLowerCase().replace(/\s+/g,"-")}},{key:"state",get:function(){return this.stateStorage.getValue(this.stateKey)},set:function(e){this.stateStorage.setValue(this.stateKey,e)}}])&&n(t.prototype,r),o&&n(t,o),e}();o(i,"STATUS_CHECKING",0),o(i,"STATUS_INSTALLING",1),o(i,"STATUS_SUCCESSED",2),o(i,"STATUS_FAILED",3),t.default=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n,o=r(0),i=r(2),s=(n=i)&&n.__esModule?n:{default:n},a=r(3);function u(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}let c=function(){function e(t,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.projectDir=t,this.options=r,this.subscriptions=[],this.dirWatchSubscriptions=[],this._rebuildTimeout=void 0,this._updateDirWatchersTimeout=void 0,this._inProgress=!1,this.setupWatchers()}var t,r,n;return t=e,(r=[{key:"requestRebuild",value:function(){this._rebuildTimeout&&clearTimeout(this._rebuildTimeout),this._rebuildTimeout=setTimeout(this.rebuild.bind(this),e.AUTO_REBUILD_DELAY)}},{key:"rebuild",value:function(){if(!this._inProgress&&(0,o.isPIOProject)(this.projectDir))return this.options.withProgress(async()=>{this._inProgress=!0;try{await new Promise((e,t)=>{(0,a.runPIOCommand)(["init","--ide",this.options.ide,"--project-dir",this.projectDir],(r,n,o)=>{0===r?e():t(new Error(o))})})}catch(e){console.warn(e)}this._inProgress=!1})}},{key:"setupWatchers",value:function(){const e=this.options.createFileSystemWatcher(s.default.join(this.projectDir,"platformio.ini"));this.subscriptions.push(e,e.onDidCreate(()=>{this.requestRebuild(),this.requestUpdateDirWatchers()}),e.onDidChange(()=>{this.requestRebuild(),this.requestUpdateDirWatchers()}),e.onDidDelete(()=>this.updateDirWatchers())),this.requestUpdateDirWatchers()}},{key:"requestUpdateDirWatchers",value:function(){this._updateDirWatchersTimeout&&clearTimeout(this._updateDirWatchersTimeout),this._updateDirWatchersTimeout=setTimeout(this.updateDirWatchers.bind(this),3*e.AUTO_REBUILD_DELAY)}},{key:"updateDirWatchers",value:async function(){if((0,o.disposeSubscriptions)(this.dirWatchSubscriptions),(0,o.isPIOProject)(this.projectDir))try{(await this.fetchWatchDirs()).forEach(e=>{const t=this.options.createDirSystemWatcher(e);this.dirWatchSubscriptions.push(t,t.onDidCreate(()=>this.requestRebuild()),t.onDidChange(()=>this.requestRebuild()),t.onDidDelete(()=>this.requestRebuild()))})}catch(e){console.warn(e)}}},{key:"fetchWatchDirs",value:async function(){e.PythonExecutable||(e.PythonExecutable=await(0,o.getPythonExecutable)(this.options.useBuiltinPIOCore));const t=["from os.path import join","from platformio import util",'print(":".join([join(util.get_home_dir(), "lib"), util.get_projectlib_dir(), util.get_projectlibdeps_dir()]))'];return new Promise((r,n)=>{(0,o.runCommand)(e.PythonExecutable,["-c",t.join(";")],(e,t,o)=>{0===e?r(t.toString().trim().split(":")):n(new Error(o))},{spawnOptions:{cwd:this.projectDir}})})}},{key:"dispose",value:function(){(0,o.disposeSubscriptions)(this.dirWatchSubscriptions),(0,o.disposeSubscriptions)(this.subscriptions),this._rebuildTimeout&&clearTimeout(this._rebuildTimeout),this._updateDirWatchersTimeout&&clearTimeout(this._updateDirWatchersTimeout)}}])&&u(t.prototype,r),n&&u(t,n),e}();!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(c,"AUTO_REBUILD_DELAY",3e3),t.default=c},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.misc=t.project=t.installer=t.home=t.core=void 0;var n=p(r(3)),o=p(r(12)),i=p(r(0)),s=r(16),a=f(r(7)),u=f(r(18)),c=f(r(8)),l=f(r(23));function f(e){return e&&e.__esModule?e:{default:e}}function p(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var n=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,r):{};n.get||n.set?Object.defineProperty(t,r,n):t[r]=e[r]}return t.default=e,t}const d={BaseStage:a.default,PlatformIOCoreStage:u.default},h={ProjectIndexer:c.default,ProjectObserver:l.default,ProjectTasks:s.ProjectTasks,TaskItem:s.TaskItem};t.core=n,t.home=o,t.installer=d,t.project=h,t.misc=i},function(e,t){e.exports=require("os")},function(e,t){e.exports=o},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getFrontendUri=function(e,t,r){const n=(b()||{}).storage||{},o={start:r.start||"/",theme:n.theme||r.theme,workspace:n.workspace||r.workspace};return Object.keys(o).forEach(e=>{[void 0,null].includes(o[e])&&delete o[e]}),`http://${e}:${t}?${u.default.stringify(o)}`},t.getFrontendVersion=async function(e,t){if(0===v)return;return await new Promise(r=>{(0,c.default)(`http://${e}:${t}/package.json`,function(e,t,n){if(e||!t||200!==t.statusCode)return r(void 0);try{return r(JSON.parse(n).version)}catch(e){}return r(void 0)})})},t.isServerStarted=g,t.ensureServerStarted=async function(e={}){let t=0,r=void 0,n=0;for(;t<3;){try{return await P(e)}catch(e){for(r=e,console.warn(e),v=0,n=m;n<y;)c.default.get(`http://${h}:${n}?__shutdown__=1`).on("error",()=>{}),n++;await(0,o.sleep)(2e3)}t++}throw(0,o.reportError)(r),r},t.shutdownServer=function(){if(!v)return;return c.default.get(`http://${h}:${v}?__shutdown__=1`)},t.loadState=b,t.showAtStartup=function(e){const t=b();return!t||!t.storage||!t.storage.showOnStartup||!t.storage.showOnStartup.hasOwnProperty(e)||t.storage.showOnStartup[e]};var n=r(3),o=r(0),i=p(r(1)),s=p(r(13)),a=p(r(2)),u=p(r(5)),c=p(r(4)),l=p(r(14)),f=p(r(15));function p(e){return e&&e.__esModule?e:{default:e}}const d=300,h="127.0.0.1",m=8010,y=8100;let v=0,w=0;function g(){return new Promise(e=>{l.default.check(v,h).then(t=>{e(t)},()=>e(!1))})}async function P(e={}){0===v&&(v=await async function(){let e=m,t=!1;for(;e<y;){if(!(t=await new Promise(t=>{l.default.check(e,h).then(e=>{t(e)},()=>t(!1))})))return e;e++}return 0}());const t={host:h,port:v};return await g()||await new Promise((e,t)=>{(0,n.runPIOCommand)(["home","--port",v,"--no-open"],(e,r,n)=>{if(0!==e)return v=0,t(new Error(n))}),l.default.waitUntilUsed(v,500,1e3*d).then(()=>{e(!0)},e=>{t(new Error("Could not start PIO Home server: "+e.toString()))})}),e.onIDECommand&&async function(e){if(w>0)return;const t=new f.default(`ws://${h}:${v}/wsrpc`,{perMessageDeflate:!1});t.onopen=(()=>{w=1,t.send(JSON.stringify(s.default.request(Math.random().toString(),"ide.listen_commands")))}),t.onclose=(()=>{w=0}),t.onmessage=(r=>{try{const t=s.default.parse(r.data);switch(t.type){case"success":e(t.payload.result.method,t.payload.result.params);break;case"error":console.error("Errored result: "+t.payload.toString())}}catch(e){console.error("Invalid RPC message: "+e.toString())}t.send(JSON.stringify(s.default.request(Math.random().toString(),"ide.listen_commands")))})}(e.onIDECommand),t}function b(){const e=a.default.join((0,n.getHomeDir)(),"homestate.json");if(!i.default.isFileSync(e))return null;try{return JSON.parse(i.default.readFileSync(e,"utf8"))}catch(e){return console.warn(e),null}}},function(e,t){e.exports=i},function(e,t){e.exports=s},function(e,t){e.exports=a},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TaskItem=t.ProjectTasks=void 0;var n=s(r(1)),o=s(r(17)),i=s(r(2));function s(e){return e&&e.__esModule?e:{default:e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function c(e,t,r){return t&&u(e.prototype,t),r&&u(e,r),e}function l(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}let f=t.ProjectTasks=function(){function e(t,r){a(this,e),this.projectDir=t,this.ide=r}return c(e,[{key:"getTasks",value:async function(){if(!this.projectDir)return[];const t=[];let r=void 0;try{const e=await new Promise((e,t)=>{n.default.readFile(i.default.join(this.projectDir,"platformio.ini"),"utf-8",(r,n)=>r?t(r):e(n))});r=o.default.parse(e)}catch(e){return console.warn(`Could not parse "platformio.ini" file in ${this.projectDir}`),t}const s=[];for(const t of Object.keys(r)){const n=r[t].platform;n&&t.startsWith(e.ENV_NAME_PREFIX)&&s.push({env:t.slice(e.ENV_NAME_PREFIX.length),platform:n})}return e.baseTasks.forEach(e=>{e.filter&&!s.some(t=>e.filter(t))||t.push(new p(e.name,e.description,e.args.slice(0)))}),s.length>1&&s.forEach(r=>{e.baseTasks.forEach(e=>{e.filter&&!e.filter(r)||t.push(new p(e.name,e.description,[...e.args.slice(0),"--environment",r.env]))})}),t.push(new p("Update project libraries",void 0,["lib","update"])),t.push(new p("Rebuild IntelliSense Index",void 0,["init","--ide",this.ide])),t}}]),e}();l(f,"ENV_NAME_PREFIX","env:"),l(f,"baseTasks",[{name:"Build",args:["run"]},{name:"Upload",args:["run","--target","upload"]},{name:"Clean",args:["run","--target","clean"]},{name:"Verbose Build",args:["run","--verbose"]},{name:"Verbose Upload",args:["run","--verbose","--target","upload"]},{name:"Upload and Monitor",args:["run","--target","upload","--target","monitor"],filter:e=>!e.platform.includes("riscv_gap")},{name:"Upload using Programmer",args:["run","--target","program"],filter:e=>e.platform.includes("atmelavr")},{name:"Upload File System image",args:["run","--target","uploadfs"],filter:e=>e.platform.includes("espressif")||e.platform.includes("riscv_gap")},{name:"Monitor",args:["device","monitor"]},{name:"Test",args:["test"]},{name:"Remote",args:["remote","run","--target","upload"]},{name:"Pre-Debug",description:"build in debug mode",args:["debug"]}]);let p=t.TaskItem=function(){function e(t,r,n){a(this,e),this.name=t,this.description=r,this.args=n}return c(e,[{key:"isBuild",value:function(){return this.name.startsWith("Build")}},{key:"isClean",value:function(){return this.name.startsWith("Clean")}},{key:"isTest",value:function(){return this.name.startsWith("Test")}},{key:"coreTarget",get:function(){if("run"!==this.args[0])return this.args[0];const e=this.args.indexOf("--target");return-1!==e?this.args[e+1]:"build"}},{key:"coreEnv",get:function(){const e=this.args.indexOf("--environment");return-1!==e?this.args[e+1]:void 0}},{key:"id",get:function(){let e=this.name;return this.coreEnv&&(e+=` (${this.coreEnv})`),e}},{key:"title",get:function(){return this.description?`${this.id} [${this.description}]`:this.id}}]),e}()},function(e,t){e.exports=u},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n=p(r(3)),o=p(r(19)),i=p(r(0)),s=f(r(7)),a=f(r(1)),u=f(r(2)),c=f(r(22)),l=f(r(6));function f(e){return e&&e.__esModule?e:{default:e}}function p(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var n=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,r):{};n.get||n.set?Object.defineProperty(t,r,n):t[r]=e[r]}return t.default=e,t}function d(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function h(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function m(e){return(m=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function y(e,t){return(y=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function v(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}let w=function(e){function t(){var e;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),e=h(this,m(t).apply(this,arguments)),l.default.setGracefulCleanup(),e}var r,f,p;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&y(e,t)}(t,s.default),r=t,(f=[{key:"whereIsPython",value:async function(){let e=this.params.pythonPrompt.STATUS_TRY_AGAIN;do{const t=await i.getPythonExecutable(this.params.useBuiltinPIOCore);if(t)return t;if(process.platform.startsWith("win"))try{return await this.installPythonForWindows()}catch(e){console.warn(e)}const r=await this.params.pythonPrompt.prompt();if((e=r.status)===this.params.pythonPrompt.STATUS_CUSTOMEXE)return r.pythonExecutable}while(e!==this.params.pythonPrompt.STATUS_ABORT);throw this.status=s.default.STATUS_FAILED,new Error("Can not find Python Interpreter")}},{key:"installPythonForWindows",value:async function(){const e="x64"===process.arch?".amd64":"",r=`https://www.python.org/ftp/python/${t.pythonVersion}/python-${t.pythonVersion}${e}.msi`,s=await o.download(r,u.default.join(n.getCacheDir(),u.default.basename(r))),c=u.default.join(n.getHomeDir(),"python27"),l=u.default.join(c,"python.exe");if(!a.default.isFileSync(l))try{await this.installPythonFromWindowsMSI(s,c)}catch(e){console.warn(e),await this.installPythonFromWindowsMSI(s,c,!0)}return process.env.PATH=[c,u.default.join(c,"Scripts"),process.env.PATH].join(u.default.delimiter),process.env.Path=process.env.PATH,new Promise(e=>{i.runCommand("pip",["install","virtualenv"],()=>e(l))})}},{key:"installPythonFromWindowsMSI",value:async function(e,t,r=!1){const o=u.default.join(n.getCacheDir(),"python27msi.log");if(await new Promise((n,s)=>{i.runCommand("msiexec.exe",[r?"/a":"/i",`"${e}"`,"/qn","/li",`"${o}"`,`TARGETDIR="${t}"`],(e,t,r)=>0===e?n(t):(a.default.isFileSync(o)&&(r=a.default.readFileSync(o).toString()),s(new Error(`MSI Python2.7: ${r}`))),{spawnOptions:{shell:!0}})}),!a.default.isFileSync(u.default.join(t,"python.exe")))throw new Error("Could not install Python 2.7 using MSI")}},{key:"cleanVirtualEnvDir",value:function(){const e=n.getEnvDir();if(!a.default.isDirectorySync(e))return!0;try{return a.default.removeSync(e),!0}catch(e){return console.warn(e),!1}}},{key:"isCondaInstalled",value:function(){return new Promise(e=>{i.runCommand("conda",["--version"],t=>e(0===t))})}},{key:"createVirtualenvWithConda",value:function(){return this.cleanVirtualEnvDir(),new Promise((e,t)=>{i.runCommand("conda",["create","--yes","--quiet","python=2","pip","--prefix",n.getEnvDir()],(r,n,o)=>0===r?e(n):t(new Error(`Conda Virtualenv: ${o}`)))})}},{key:"createVirtualenvWithLocal",value:async function(){let e=void 0;this.cleanVirtualEnvDir();const t=await this.whereIsPython();try{e=await new Promise((e,r)=>{i.runCommand(t,["-m","virtualenv","-p",t,n.getEnvDir()],(t,n,o)=>0===t?e(n):r(new Error(`User's Virtualenv: ${o}`)))})}catch(r){this.cleanVirtualEnvDir(),e=await new Promise((e,r)=>{i.runCommand("virtualenv",["-p",t,n.getEnvDir()],(t,n,o)=>0===t?e(n):r(new Error(`User's Virtualenv: ${o}`)))})}return e}},{key:"createVirtualenvWithDownload",value:async function(){this.cleanVirtualEnvDir();const e=await o.download(t.virtualenvUrl,u.default.join(n.getCacheDir(),"virtualenv.tar.gz")),r=l.default.dirSync({dir:n.getCacheDir(),unsafeCleanup:!0}).name,s=await o.extractTarGz(e,r),c=a.default.listTreeSync(s).find(e=>"virtualenv.py"===u.default.basename(e));if(!c)throw new Error("Can not find virtualenv.py script");const f=await this.whereIsPython();return new Promise((e,t)=>{i.runCommand(f,[c,n.getEnvDir()],(n,o,i)=>{try{a.default.removeSync(r)}catch(e){console.warn(e)}if(0===n)return e(o);{let e=`Virtualenv Create: ${i}\n${o}`;return i.includes("WindowsError: [Error 5]")&&(e=`If you use Antivirus, it can block PlatformIO Installer. Try to disable it for a while.\n\n${e}`),t(new Error(e))}})})}},{key:"installVirtualenvPackage",value:async function(){const e=await this.whereIsPython();return new Promise((t,r)=>{i.runCommand(e,["-m","pip","install","virtualenv"],(e,n,o)=>0===e?t(n):r(new Error(`Install Virtualenv globally: ${o}`)))})}},{key:"createVirtualenv",value:async function(){if(await this.isCondaInstalled())return await this.createVirtualenvWithConda();try{await this.createVirtualenvWithLocal()}catch(e){console.warn(e);try{await this.createVirtualenvWithDownload()}catch(e){console.warn(e);try{await this.installVirtualenvPackage(),await this.createVirtualenvWithLocal()}catch(t){throw i.reportError(e),console.warn(t),new Error(`Could not create PIO Core Virtual Environment. Please create it manually -> http://bit.ly/pio-core-virtualenv \n ${e.toString()}`)}}}}},{key:"upgradePIP",value:async function(e){const r=await o.download(t.pipUrl,u.default.join(n.getCacheDir(),u.default.basename(t.pipUrl)));return new Promise((t,n)=>{i.runCommand(e,["-m","pip","install","-U",r],(e,r,o)=>0===e?t(r):n(o))})}},{key:"installPIOCore",value:async function(){const e=await this.whereIsPython();try{await this.upgradePIP(e)}catch(e){console.warn(e),i.reportError(new Error(`Upgrade PIP: ${e.toString()}`))}const r=["-m","pip","install","-U"];return this.params.useDevelopmentPIOCore?r.push(t.pioCoreDevelopUrl):r.push("platformio"),new Promise((t,n)=>{i.runCommand(e,r,(e,r,o)=>{if(0!==e)return i.IS_WINDOWS&&(o=`If you have antivirus/firewall/defender software in a system, try to disable it for a while. \n ${o}`),n(new Error(`PIP Core: ${o}`));t(r)})})}},{key:"installPIOHome",value:function(){return new Promise(e=>{n.runPIOCommand(["home","--host","__do_not_start__"],(t,r,n)=>(0!==t&&console.warn(r,n),e(!0)))})}},{key:"initState",value:function(){let e=this.state;return e&&e.hasOwnProperty("pioCoreChecked")&&e.hasOwnProperty("lastIDEVersion")||(e={pioCoreChecked:0,lastIDEVersion:null}),e}},{key:"autoUpgradePIOCore",value:async function(e){const r=this.initState(),o=(new Date).getTime();(process.env.PLATFORMIO_IDE&&r.lastIDEVersion&&r.lastIDEVersion!==process.env.PLATFORMIO_IDE||o-t.UPGRADE_PIOCORE_TIMEOUT>parseInt(r.pioCoreChecked))&&(r.pioCoreChecked=o,await new Promise(t=>{n.runPIOCommand(["upgrade",...this.params.useDevelopmentPIOCore&&!c.default.prerelease(e)?["--dev"]:[]],(e,r,n)=>{0!==e&&console.warn(r,n),t(!0)})})),r.lastIDEVersion=process.env.PLATFORMIO_IDE,this.state=r}},{key:"check",value:async function(){const e=o.PEPverToSemver(await n.getVersion());if(this.params.useBuiltinPIOCore){if(!a.default.isDirectorySync(n.getEnvBinDir()))throw new Error("Virtual environment is not created");if(c.default.lt(e,"3.5.0-rc.4"))throw new Error("Force new python environment");try{await this.autoUpgradePIOCore(e)}catch(e){console.warn(e)}}if(c.default.lt(e,this.params.pioCoreMinVersion))throw this.params.setUseBuiltinPIOCore(!0),this.params.useBuiltinPIOCore=!0,this.params.useDevelopmentPIOCore=this.params.useDevelopmentPIOCore||c.default.prerelease(this.params.pioCoreMinVersion),new Error(`Incompatible PIO Core ${e}`);return this.status=s.default.STATUS_SUCCESSED,console.info(`Found PIO Core ${e}`),!0}},{key:"install",value:async function(){if(this.status===s.default.STATUS_SUCCESSED)return!0;if(!this.params.useBuiltinPIOCore)return this.status=s.default.STATUS_SUCCESSED,!0;this.status=s.default.STATUS_INSTALLING;try{await this.createVirtualenv(),await this.installPIOCore(),await this.installPIOHome()}catch(e){throw i.reportError(e),e}return this.status=s.default.STATUS_SUCCESSED,!0}},{key:"name",get:function(){return"PlatformIO Core"}}])&&d(r.prototype,f),p&&d(r,p),t}();v(w,"UPGRADE_PIOCORE_TIMEOUT",6048e5),v(w,"pythonVersion","2.7.13"),v(w,"pipUrl","https://files.pythonhosted.org/packages/45/ae/8a0ad77defb7cc903f09e551d88b443304a9bd6e6f124e75c0fbbf6de8f7/pip-18.1.tar.gz"),v(w,"virtualenvUrl","https://files.pythonhosted.org/packages/4e/8b/75469c270ac544265f0020aa7c4ea925c5284b23e445cf3aa8b99f662690/virtualenv-16.1.0.tar.gz"),v(w,"pioCoreDevelopUrl","https://github.com/platformio/platformio/archive/develop.zip"),t.default=w},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.download=async function(e,t,r=3){const n=await(i=e,new Promise(e=>{o.default.head({url:i},(t,r)=>{!t&&200===r.statusCode&&r.headers.hasOwnProperty("content-length")||e(-1),e(parseInt(r.headers["content-length"]))})}));var i;if(c(t,n))return t;let s="";for(;r>=0;){try{if(await l(e,t),c(t,n))return t}catch(e){s=e,console.warn(e)}r--}throw new Error(`Failed to download file ${e}: ${s}`)},t.extractTarGz=function(e,t){return new Promise((r,o)=>{n.default.createReadStream(e).pipe(a.default.createGunzip()).on("error",e=>o(e)).pipe(s.default.extract({cwd:t})).on("error",e=>o(e)).on("close",()=>r(t))})},t.PEPverToSemver=function(e){return e.replace(/(\.\d+)\.?(dev|a|b|rc|post)/,"$1-$2.")};var n=u(r(1)),o=u(r(4)),i=r(0),s=u(r(20)),a=u(r(21));function u(e){return e&&e.__esModule?e:{default:e}}function c(e,t){if(n.default.isFileSync(e)){if(t>0&&t==n.default.getSizeSync(e))return!0;try{n.default.removeSync(e)}catch(e){console.warn(e)}}return!1}async function l(e,t){let r=null;try{const e=atom.packages.getApmPath();r=await new Promise((t,r)=>{(0,i.runCommand)(e,["--no-color","config","get","https-proxy"],(e,n)=>{if(0!==e)return r(null);t("null"===n.trim()?null:n.trim())})})}catch(e){r=process.env.HTTPS_PROXY&&process.env.HTTPS_PROXY.trim()||process.env.HTTP_PROXY&&process.env.HTTP_PROXY.trim()}return new Promise((i,s)=>{const a=n.default.createWriteStream(t),u={url:e};r&&(u.proxy=r),o.default.get(u).on("error",e=>s(e)).pipe(a),a.on("error",e=>s(e)),a.on("finish",()=>i(t))})}},function(e,t){e.exports=c},function(e,t){e.exports=require("zlib")},function(e,t){e.exports=l},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n,o=r(8),i=(n=o)&&n.__esModule?n:{default:n},s=r(0);function a(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}let u=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.options=t,this._indexers=[]}var t,r,n;return t=e,(r=[{key:"update",value:async function(e){this._indexers=this._indexers.filter(t=>!!e.includes(t.projectDir)||(t.dispose(),!1));for(const t of e){if(this._indexers.some(e=>e.projectDir===t))continue;const e=new i.default(t,this.options);this._indexers.push(e),await e.rebuild()}}},{key:"rebuildIndex",value:function(){this._indexers.forEach(e=>e.rebuild())}},{key:"dispose",value:function(){(0,s.disposeSubscriptions)(this._indexers)}}])&&a(t.prototype,r),n&&a(t,n),e}();t.default=u}])});
//# sourceMappingURL=index.js.map